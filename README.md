# Текст задания

Разработать алгоритм торгового робота, который автоматически совершает сделки на основе скользящих средних и стоп-лосса, анализируя исторические данные акций.

Обязательно использовать реальные дневные данные стоимости акций с бирж, например нью-йоркской или московской биржи.

**Дополнительные баллы (11/10): Подключение торгового робота к API брокера (Тинькофф, ВТБ, etc.) и тестирование на российских акциях**  

- **Тинькофф Инвестиции** ([API Docs](https://tinkoff.github.io/investAPI/))  
- **ВТБ Инвестиции** ([API Docs](https://www.vtb.ru/o-banke/novosti-i-press-relizy/press-relizy/2023/02/09022023/))  

---

## Обязательные переменные:
1. **`money`** – стартовый капитал (1 000 000 денежных единиц).  
2. **`start`** – дата начала периода в формате `YYYY-MM-DD` (2015-01-01).  
3. **`finish`** – дата окончания периода в формате `YYYY-MM-DD` (2020-12-31).  
4. **`stop_loss`** – уровень стоп-лосса (5% от цены покупки).  
5. **`short_window`** – размер короткого скользящего окна (30 торговых дней).  
6. **`long_window`** – размер длинного скользящего окна (90 торговых дней).  

**Примечания:**  
- Скользящие окна рассчитываются как **простое среднее**.  
- Все переменные объявляются в отдельном блоке **после импорта библиотек**.

---

## Правила торговли:
### Сигналы:
- **`sig_buy`** (покупка):  
  Короткая скользящая средняя пересекает длинную **снизу вверх**.  
- **`sig_sale`** (продажа):  
  Короткая скользящая средняя пересекает длинную **сверху вниз**.  

### Исполнение сделок:
- Покупка/продажа происходит **на следующий день** после сигнала по цене открытия.  
- При покупке:  
  - Используется **весь доступный капитал**.  
  - Покупается **максимально возможное целое количество акций**.  
  - Фиксируется **стоп-лосс** на уровне:  
    `цена покупки × (1 - stop_loss / 100)`.  
- При продаже:  
  - Продается **весь объем акций**.  
  - Стоп-лосс срабатывает, если **цена Low** в любой день (включая день покупки) опускается ниже уровня стоп-лосса.  
  - Продажа происходит **по цене стоп-лосса**, даже если фактическая цена ниже.

---

## Исходные данные:
- Формат данных: `Pandas DataFrame`.  
- Индекс: дата/время (тип `datetime`).  
- Колонки (обязательный порядок):  
  `Open`, `High`, `Low`, `Close`.  
- Источник данных: реальные дневные котировки с **NYSE** или **Московской биржи**.  

---

## Требования к отчету:
Отчет (`DataFrame`) должен содержать следующие колонки:  
| Колонка         | Описание                                                                 |
|-----------------|-------------------------------------------------------------------------|
| **date**        | Дата события (формат `YYYY-MM-DD`).                                    |
| **signal**      | Тип сигнала: `sig_buy`, `buy`, `sig_sale`, `sale`, `stop-loss`.        |
| **num_shares**  | Количество акций на балансе (целое число, ≥ 0).                        |
| **share_price** | Цена акции на момент действия сигнала (в день сделки).                 |
| **share_value** | Текущая стоимость портфеля (`num_shares × share_price`).              |
| **cash**        | Наличные на счете (округление до **2 знаков** после запятой!).         |

**Пример полного отчета:**  
| date       | signal      | num_shares | share_price | share_value  | cash          |
|------------|-------------|------------|-------------|--------------|---------------|
| 2020-01-01 | sig_buy     | 0          | 100.00      | 0.00         | 1,000,000.00  |
| 2020-01-02 | buy         | 10101      | 99.00       | 999,999.00   | 1.00          |
| 2020-02-22 | sig_sale    | 10101      | 125.00      | 1,262,625.00 | 1.00          |
| 2020-02-23 | sale        | 10101      | 125.62      | 0.00         | 1,268,888.62  |
| 2020-03-11 | sig_buy     | 0          | 125.45      | 0.00         | 1,268,888.62  |
| 2020-03-12 | buy         | 10044      | 126.33      | 1,268,858.52 | 30.10         |
| 2020-03-18 | stop-loss   | 10044      | 120.01      | 1 205 380.44 | 1,205,410.54  |
| 2020-05-01 | sig_buy     | 0          | 70.00       | 0.00         | 1,205,410.54  |

**Итоговые расчеты:**  
- Вывести **итоговую стоимость портфеля** на момент последней сделки (`sale` или `stop-loss`).  
- Рассчитать **процент прироста/убытка** от начального капитала по формуле:  
  ```
  Процент = ((Итоговая стоимость - 1,000,000) / 1,000,000) × 100%
  ```

---

## Визуализация:
### Верхнее окно:
- **График цен**:  
  - Тип: свечи (`candlestick`) или OHLC.  
  - Динамический масштаб (возможность приближения/удаления).  
  - Наложение скользящих средних:  
    - Короткая (30 дней) — синяя линия.  
    - Длинная (90 дней) — оранжевая линия.  
- **Сигналы**:  
  - `sig_buy` — зеленый треугольник (▲) вверх.  
  - `sig_sale` — красный треугольник (▼) вниз.  
  - `stop-loss` — черный треугольник (▼) вниз.  

### Нижнее окно:
- **График позиции**:  
  - Ось Y: `1` (все средства в акциях), `0` (все средства в кэше).  

**Примеры реализации**:  
- [Свечной график с Plotly](https://community.plotly.com/t/ohlc-candlestick-graph-with-volume/52341)  
- [mplfinance документация](https://github.com/matplotlib/mplfinance)  

---

**Важно!**  
- Если в конце периода открыта позиция (есть акции), прибыль/убыток считается по последней сделке.  
- Все расчеты должны быть автоматизированы (никакого ручного ввода!).  # stock_robot
